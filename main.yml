---
- name: Create Pihole Directories and Set Permissions
  hosts: piholes
  become: true

  tasks:
    - name: Create directories
      file:
        path: "/data/pihole/{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - etc
        - dnsmasq.d

    - name: Set permissions
      file:
        path: "/data/pihole/{{ item }}"
        mode: '0644'
      with_items:
        - etc
        - dnsmasq.d

- name: Create Pi-hole Kubernetes Service
  hosts: piholes
  become: false

  tasks:
    - name: Create NodePort Service
      k8s:
        api_version: v1
        kind: Service
        name: pihole-service
        namespace: pihole
        spec:
          selector:
            app: pihole
          ports:
            - name: dns
              protocol: TCP
              port: 53
              target_port: 53
              node_port: 53

- name: Deploy Pi-hole Kubernetes Pods
  hosts: piholes
  become: false

  vars:
    nameservers:
    - 1.1.1.1       # Cloudflare
    - 8.8.8.8       # Google
    - 9.9.9.9       # Quad9
    - 208.67.222.222 # OpenDNS
    - 208.67.220.220 # OpenDNS
    - 64.6.64.6     # Verisign
    - 64.6.65.6     # Verisign
    - 77.88.8.8     # Yandex.DNS
    TZ: "America/New_York"
    WEBPASSWORD: "{{ lookup('env', 'PIHOLE_PASSWORD') | default('piholeadmin') }}"
    image: "pihole/pihole:2024.01.0"
    k8s_manifests_dir: "/etc/kubernetes/manifests"

  tasks:
    - name: Create Pi-hole YAML file
      template:
        src: templates/pihole_pod.yaml.j2
        dest: "pihole_pod.yaml"

    - name: Copy YAML file to Kubernetes manifests directory
      copy:
        src: "pihole_pod.yaml"
        dest: "{{ k8s_manifests_dir }}/pihole_pod.yaml"
  
  - name: Wait for first pihole to be online
      wait_for:
        host: "{{ groups['piholes'][0] }}"  # Use the first node in the 'piholes' group
        port: 53
        state: started
        delay: 10
        timeout: 300
